// src/pages/AdminDashboardPage.jsx
import React, { useEffect, useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { useAdmin } from '../contexts/AdminContext';
import {
  getAdminStats,
  changeAdminPassword,
  fetchOrders,
  adminUpdateOrderStatus,
  fetchProducts,
  adminCreateProduct,
  adminUpdateProduct,
  adminDeleteProduct,
} from '../services/api';

const AdminDashboardPage = () => {
  const { admin, isLoggedIn, logout } = useAdmin();
  const navigate = useNavigate();

  // الإحصائيات
  const [stats, setStats] = useState(null);
  const [statsError, setStatsError] = useState(null);

  // الطلبات
  const [orders, setOrders] = useState([]);
  const [statusFilter, setStatusFilter] = useState('');
  const [ordersError, setOrdersError] = useState(null);
  const [ordersLoading, setOrdersLoading] = useState(false);

  // تغيير كلمة المرور
  const [pwForm, setPwForm] = useState({ old_password: '', new_password: '' });
  const [pwMsg, setPwMsg] = useState(null);
  const [pwError, setPwError] = useState(null);
  const [pwLoading, setPwLoading] = useState(false);

  // إدارة المنتجات
  const [products, setProducts] = useState([]);
  const [productsLoading, setProductsLoading] = useState(false);
  const [productsError, setProductsError] = useState(null);
  const [editingProductId, setEditingProductId] = useState(null);
  const [productForm, setProductForm] = useState({
    name: '',
    description: '',
    category: '',
    price: '',
    images_text: '',
    sizes_text: '',
    is_offer: false,
    discount_price: '',
  });

  // حماية مسار الأدمن: لو مش داخل → روح لصفحة الدخول
  useEffect(() => {
    if (!isLoggedIn) {
      navigate('/admin/login');
    }
  }, [isLoggedIn, navigate]);

  // تحميل الإحصائيات
  useEffect(() => {
    if (!admin?.token) return;
    const loadStats = async () => {
      try {
        setStatsError(null);
        const data = await getAdminStats(admin.token);
        setStats(data);
      } catch (err) {
        setStatsError(err.message || 'فشل تحميل الإحصائيات');
      }
    };
    loadStats();
  }, [admin]);

  // تحميل الطلبات حسب الفلتر
  useEffect(() => {
    const loadOrders = async () => {
      try {
        setOrdersLoading(true);
        setOrdersError(null);
        const data = await fetchOrders(statusFilter || undefined);
        setOrders(data);
      } catch (err) {
        setOrdersError(err.message || 'فشل تحميل الطلبات');
      } finally {
        setOrdersLoading(false);
      }
    };
    loadOrders();
  }, [statusFilter]);

  // تحميل المنتجات لإدارة العروض والأصناف
  useEffect(() => {
    const loadProducts = async () => {
      try {
        setProductsLoading(true);
        setProductsError(null);
        const data = await fetchProducts();
        setProducts(data);
      } catch (err) {
        setProductsError(err.message || 'فشل تحميل المنتجات');
      } finally {
        setProductsLoading(false);
      }
    };

    loadProducts();
  }, []);

  // تغيير كلمة المرور
  const handlePwChange = (e) => {
    const { name, value } = e.target;
    setPwForm((prev) => ({ ...prev, [name]: value }));
  };

  const handlePwSubmit = async (e) => {
    e.preventDefault();
    if (!admin?.token) return;
    setPwError(null);
    setPwMsg(null);
    try {
      setPwLoading(true);
      const res = await changeAdminPassword(admin.token, pwForm);
      setPwMsg(res.message || 'تم تغيير كلمة المرور بنجاح');
      setPwForm({ old_password: '', new_password: '' });
    } catch (err) {
      setPwError(err.message || 'فشل تغيير كلمة المرور');
    } finally {
      setPwLoading(false);
    }
  };

  const handleLogout = () => {
    logout();
    navigate('/');
  };

  // تغيير حالة الطلب من جدول الطلبات
  const handleOrderStatusChange = async (orderId, newStatus) => {
    if (!admin?.token) return;
    try {
      await adminUpdateOrderStatus(admin.token, orderId, newStatus);
      setOrders((prev) =>
        prev.map((o) => (o.id === orderId ? { ...o, status: newStatus } : o))
      );
    } catch (err) {
      alert(err.message || 'فشل تحديث حالة الطلب');
    }
  };

  // إدارة نموذج المنتج
  const resetProductForm = () => {
    setEditingProductId(null);
    setProductForm({
      name: '',
      description: '',
      category: '',
      price: '',
      images_text: '',
      sizes_text: '',
      is_offer: false,
      discount_price: '',
    });
  };

  const handleProductFormChange = (e) => {
    const { name, value, type, checked } = e.target;
    setProductForm((prev) => ({
      ...prev,
      [name]: type === 'checkbox' ? checked : value,
    }));
  };

  const startEditProduct = (product) => {
    setEditingProductId(product.id);
    setProductForm({
      name: product.name,
      description: product.description,
      category: product.category,
      price: String(product.price),
      images_text: (product.images || []).join(','),
      sizes_text: JSON.stringify(product.sizes || []),
      is_offer: !!product.is_offer,
      discount_price:
        product.discount_price != null ? String(product.discount_price) : '',
    });
  };

  const handleProductSubmit = async (e) => {
    e.preventDefault();
    if (!admin?.token) return;

    try {
      setProductsError(null);

      const price = parseFloat(productForm.price || '0');
      const discountPrice = productForm.discount_price
        ? parseFloat(productForm.discount_price)
        : null;

      const images = productForm.images_text
        .split(',')
        .map((s) => s.trim())
        .filter(Boolean);

      let sizes = [];
      if (productForm.sizes_text.trim()) {
        try {
          sizes = JSON.parse(productForm.sizes_text);
        } catch (err) {
          setProductsError('صيغة المقاسات غير صحيحة، يرجى إدخال JSON صحيح');
          return;
        }
      }

      const payload = {
        name: productForm.name,
        description: productForm.description,
        category: productForm.category,
        price,
        images,
        sizes,
        is_offer: productForm.is_offer,
        discount_price: discountPrice,
      };

      if (editingProductId) {
        const updated = await adminUpdateProduct(
          admin.token,
          editingProductId,
          payload,
        );
        setProducts((prev) =>
          prev.map((p) => (p.id === editingProductId ? updated : p)),
        );
      } else {
        const created = await adminCreateProduct(admin.token, payload);
        setProducts((prev) => [created, ...prev]);
      }

      resetProductForm();
    } catch (err) {
      setProductsError(err.message || 'فشل حفظ المنتج');
    }
  };

  const handleDeleteProduct = async (id) => {
    if (!admin?.token) return;
    const ok = window.confirm('هل أنت متأكد من حذف هذا المنتج؟');
    if (!ok) return;

    try {
      await adminDeleteProduct(admin.token, id);
      setProducts((prev) => prev.filter((p) => p.id !== id));
    } catch (err) {
      setProductsError(err.message || 'فشل حذف المنتج');
    }
  };

  return (
    <div className="rt-page rt-admin-page">
      {/* هيدر الأدمن مع اللوقو والزر */}
      <div className="rt-admin-header">
        <div className="rt-admin-header-left">
          <div className="rt-admin-logo-wrap">
            <img
              src="/logo-royal-touch.png"
              alt="Royal Touch"
              className="rt-admin-logo-img"
            />
            <div>
              <div className="rt-admin-title-main">لوحة تحكم Royal Touch</div>
              <div className="rt-admin-title-sub">إدارة الطلبات والمنتجات</div>
            </div>
          </div>
        </div>
        <div className="rt-admin-header-right">
          <span className="rt-admin-welcome">
            مرحباً، <strong>{admin?.username}</strong>
          </span>
          <button className="rt-secondary-btn" onClick={handleLogout}>
            تسجيل خروج
          </button>
        </div>
      </div>

      {/* الإحصائيات */}
      <section className="rt-section">
        <div className="rt-section-header">
          <h2>الإحصائيات العامة</h2>
        </div>
        {statsError && <div className="rt-error">{statsError}</div>}
        {!stats && !statsError ? (
          <div>جاري تحميل الإحصائيات...</div>
        ) : (
          stats && (
            <div className="rt-admin-stats-grid">
              <div className="rt-admin-stat-card">
                <span className="label">عدد المنتجات</span>
                <span className="value">{stats.total_products}</span>
              </div>
              <div className="rt-admin-stat-card">
                <span className="label">عدد الطلبات</span>
                <span className="value">{stats.total_orders}</span>
              </div>
              <div className="rt-admin-stat-card">
                <span className="label">طلبات قيد الانتظار</span>
                <span className="value">{stats.pending_orders}</span>
              </div>
              <div className="rt-admin-stat-card">
                <span className="label">إجمالي الإيرادات</span>
                <span className="value">
                  {stats.total_revenue.toFixed(2)} د.ل
                </span>
              </div>
            </div>
          )
        )}
      </section>

      {/* الطلبات */}
      <section className="rt-section">
        <div className="rt-section-header">
          <h2>الطلبات</h2>
          <div className="rt-admin-filter-wrap">
            <label>فلترة حسب الحالة:</label>
            <select
              value={statusFilter}
              onChange={(e) => setStatusFilter(e.target.value)}
            >
              <option value="">الكل</option>
              <option value="pending">قيد الانتظار</option>
              <option value="confirmed">مؤكد</option>
              <option value="delivered">تم التسليم</option>
              <option value="cancelled">ملغي</option>
            </select>
          </div>
        </div>

        {ordersError && <div className="rt-error">{ordersError}</div>}
        {ordersLoading ? (
          <div>جاري تحميل الطلبات...</div>
        ) : (
          <div className="rt-admin-orders-table">
            <table>
              <thead>
                <tr>
                  <th>رقم الطلب</th>
                  <th>اسم الزبون</th>
                  <th>الهاتف</th>
                  <th>الإجمالي</th>
                  <th>الحالة</th>
                  <th>التاريخ</th>
                </tr>
              </thead>
              <tbody>
                {orders.map((order) => (
                  <tr key={order.id}>
                    <td>{order.order_number}</td>
                    <td>{order.customer_info?.name}</td>
                    <td>{order.customer_info?.phone}</td>
                    <td>{order.total_amount} د.ل</td>
                    <td>
                      <select
                        className="rt-admin-status-select"
                        value={order.status}
                        onChange={(e) =>
                          handleOrderStatusChange(order.id, e.target.value)
                        }
                      >
                        <option value="pending">pending</option>
                        <option value="confirmed">confirmed</option>
                        <option value="delivered">delivered</option>
                        <option value="cancelled">cancelled</option>
                      </select>
                    </td>
                    <td>
                      {new Date(order.order_date).toLocaleString('ar-LY')}
                    </td>
                  </tr>
                ))}
                {orders.length === 0 && (
                  <tr>
                    <td colSpan="6" style={{ textAlign: 'center' }}>
                      لا توجد طلبات
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        )}
      </section>

      {/* تغيير كلمة المرور */}
      <section className="rt-section">
        <div className="rt-section-header">
          <h2>تغيير كلمة مرور الأدمن</h2>
        </div>
        <form
          className="rt-checkout-form rt-admin-card"
          style={{ maxWidth: 420 }}
          onSubmit={handlePwSubmit}
        >
          <div className="rt-field">
            <label>كلمة المرور الحالية</label>
            <input
              type="password"
              name="old_password"
              value={pwForm.old_password}
              onChange={handlePwChange}
            />
          </div>
          <div className="rt-field">
            <label>كلمة المرور الجديدة</label>
            <input
              type="password"
              name="new_password"
              value={pwForm.new_password}
              onChange={handlePwChange}
            />
          </div>
          {pwError && <div className="rt-error">{pwError}</div>}
          {pwMsg && <div className="rt-success">{pwMsg}</div>}
          <button className="rt-primary-btn" type="submit" disabled={pwLoading}>
            {pwLoading ? 'جاري التغيير...' : 'تغيير كلمة المرور'}
          </button>
        </form>
      </section>

      {/* إدارة المنتجات والعروض */}
      <section className="rt-section">
        <div className="rt-section-header">
          <h2>إدارة المنتجات والعروض</h2>
          <p className="rt-section-subtitle">
            من هنا تقدر تضيف منتجات جديدة، تعدّل منتجات قديمة، أو تحذفها.
          </p>
        </div>

        <form
          className="rt-checkout-form rt-admin-card"
          style={{ marginBottom: '1.25rem' }}
          onSubmit={handleProductSubmit}
        >
          <div className="rt-admin-form-grid">
            <div className="rt-field">
              <label>اسم المنتج</label>
              <input
                name="name"
                value={productForm.name}
                onChange={handleProductFormChange}
              />
            </div>
            <div className="rt-field">
              <label>الفئة / التصنيف</label>
              <input
                name="category"
                value={productForm.category}
                onChange={handleProductFormChange}
              />
            </div>
            <div className="rt-field">
              <label>السعر الأساسي</label>
              <input
                name="price"
                type="number"
                step="0.01"
                value={productForm.price}
                onChange={handleProductFormChange}
              />
            </div>
            <div className="rt-field rt-field-inline">
              <label className="rt-checkbox-label">
                <input
                  type="checkbox"
                  name="is_offer"
                  checked={productForm.is_offer}
                  onChange={handleProductFormChange}
                />{' '}
                عرض خاص
              </label>
              {productForm.is_offer && (
                <input
                  className="rt-inline-input"
                  name="discount_price"
                  type="number"
                  step="0.01"
                  placeholder="سعر العرض"
                  value={productForm.discount_price}
                  onChange={handleProductFormChange}
                />
              )}
            </div>
          </div>

          <div className="rt-field">
            <label>الوصف</label>
            <textarea
              name="description"
              value={productForm.description}
              onChange={handleProductFormChange}
            />
          </div>

          <div className="rt-field">
            <label>صور المنتج (روابط مفصولة بفاصلة ,)</label>
            <input
              name="images_text"
              value={productForm.images_text}
              onChange={handleProductFormChange}
              placeholder="https://image1.jpg, https://image2.jpg"
            />
          </div>

          <div className="rt-field">
            <label>المقاسات (JSON)</label>
            <textarea
              name="sizes_text"
              value={productForm.sizes_text}
              onChange={handleProductFormChange}
              placeholder='[{"size":"S","quantity":10},{"size":"M","quantity":5}]'
            />
          </div>

          {productsError && <div className="rt-error">{productsError}</div>}

          <div className="rt-admin-form-actions">
            <button className="rt-primary-btn" type="submit">
              {editingProductId ? 'تحديث المنتج' : 'إضافة منتج'}
            </button>
            {editingProductId && (
              <button
                type="button"
                className="rt-secondary-btn"
                onClick={resetProductForm}
              >
                إلغاء التعديل
              </button>
            )}
          </div>
        </form>

        {productsLoading ? (
          <div>جاري تحميل المنتجات...</div>
        ) : (
          <div className="rt-admin-products-table">
            <table>
              <thead>
                <tr>
                  <th>الاسم</th>
                  <th>الفئة</th>
                  <th>السعر</th>
                  <th>عرض؟</th>
                  <th>تاريخ الإنشاء</th>
                  <th>تحكم</th>
                </tr>
              </thead>
              <tbody>
                {products.map((p) => (
                  <tr key={p.id}>
                    <td>{p.name}</td>
                    <td>{p.category}</td>
                    <td>{p.price} د.ل</td>
                    <td>{p.is_offer ? 'نعم' : 'لا'}</td>
                    <td>
                      {p.created_at
                        ? new Date(p.created_at).toLocaleString('ar-LY')
                        : '-'}
                    </td>
                    <td>
                      <button
                        className="rt-link-button"
                        type="button"
                        onClick={() => startEditProduct(p)}
                      >
                        تعديل
                      </button>
                      <button
                        className="rt-text-btn"
                        type="button"
                        onClick={() => handleDeleteProduct(p.id)}
                      >
                        حذف
                      </button>
                    </td>
                  </tr>
                ))}
                {products.length === 0 && (
                  <tr>
                    <td colSpan="6" style={{ textAlign: 'center' }}>
                      لا توجد منتجات حالياً
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        )}
      </section>
    </div>
  );
};

export default AdminDashboardPage;
